//@Library('jenkins-shared-library')
def app
def gv
def variable

pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = credentials('docker_hub')
        GITHUB_CREDENTIALS = credentials('github-token')
    }

    stages {
        stage('Clone repository') {
            steps {
                checkout scm
            }
        }

        stage('Init') {
            steps {
                script {
                    gv = load "script.groovy"
                }
            }
        }

        stage('Build image') {
            steps {
                script {
                    //buildImage 'simpleapp'
                    gv.job('Build')
                    app = docker.build("medch1/simpleapp", ".")
                }
            }
        }

        stage('Snyk') {
            steps {
                script {
                    gv.job('Scan')
                    withCredentials([string(credentialsId: 'snyk_token_secret', variable: 'SNYK_TOKEN')]) {
                        sh "snyk auth $SNYK_TOKEN"
                    }

                    variable = sh(script: 'snyk container test registry.hub.docker.com/medch1/simpleapp --severity-threshold=critical --json > report.json', returnStatus: true)
                    echo "error code = ${variable}"

                    if (variable != 0) {
                        discordSend description: env.JOB_NAME + " \n Build: " + env.BUILD_NUMBER, footer: '', image: '', link: env.BUILD_URL, result: currentBuild.currentResult, scmWebUrl: '', thumbnail: '', title: 'Jenkins Job Update ', webhookURL: 'https://discord.com/api/webhooks/1067068756049801286/gJluS5Fa5klo_mT2hLL6nkZyW8NpYW1SsJfCu1bMd7_02eq2-_pam2KelcOhnLAZpHpf'
                    }
                }
            }
        }

        stage('Push image') {
            steps {
                script {
                    if (variable == 0) {
                        dockerLogin()
                        pushImage 'simpleapp'
                    }
                }
            }
        }


    }
}
